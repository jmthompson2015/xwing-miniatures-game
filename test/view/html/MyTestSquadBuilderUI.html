<!DOCTYPE html>
<html lang="en">
<head>
  <title>MyTestSquadBuilderUI</title>

  <link rel="stylesheet" href="../../../lib/tachyons/tachyons-4.8.1.css">
  <link rel="stylesheet" href="../../../lib/xwing-miniatures-font/xwing-miniatures-font-1.0.29/xwing-miniatures.css">
  <link rel="stylesheet" href="../../../src/view/css/style.css">

  <script src="../../../lib/requirejs/require-2.3.5.js"></script>
  <script src="../js/require-config.js"></script>
  <script src="../../../src/main.js"></script>

  <style>
    .factionTable {
      background-color: #F0F0F0;
    }
  </style>
</head>
<body>
  <table>
    <tr>
      <td>
        <table class="factionTable">
          <tr>
            <td>Faction:</td>
            <td id="factionSelect"></td>
          </tr>
        </table>
      </td>
    </tr>
    <tr>
      <td id="squadBuilderPanel"></td>
    </tr>
  </table>
  <script>
    "use strict";

    require(["react", "react-dom", "redux", "common/js/Logger", "artifact/js/Faction",
        "model/js/Reducer", "model/js/Squad", "model/js/AgentSquadAction", "model/js/AgentSquadReducer", "model/js/CardInstance",
        "view/js/Select", "view/js/SquadBuilderUI"
      ],
      function(React, ReactDOM, Redux, Logger, Faction,
        DelegateReducer, Squad, AgentSquadAction, AgentSquadReducer, CardInstance, Select, SquadBuilderUI)
      {
        window.LOGGER = new Logger();
        LOGGER.setTraceEnabled(false);
        LOGGER.setDebugEnabled(false);

        var resourceBase = "../../../src/view/resource/";
        var faction = Faction.properties[Faction.IMPERIAL];
        var store = Redux.createStore(AgentSquadReducer.root);
        var delegateStore = Redux.createStore(DelegateReducer.root);

        var displayItemChanged = function(displayItem)
        {
          store.dispatch(AgentSquadAction.setDisplayItem(displayItem));
          renderSquadBuilderUI();
        };
        var pilotChanged = function(pilot, index)
        {
          store.dispatch(AgentSquadAction.setPilot(pilot, index));

          if (pilot.fore)
          {
            store.dispatch(AgentSquadAction.setPilot(pilot.fore, this.computePilotIndexFore(index)));
            store.dispatch(AgentSquadAction.setPilot(pilot.aft, this.computePilotIndexAft(index)));
          }

          var squad = createSquad();
          store.dispatch(AgentSquadAction.setSquad(squad));
          renderSquadBuilderUI();
        };
        var pilotUpgradeChanged = function(pilotIndex, upgrade, upgradeIndex)
        {
          store.dispatch(AgentSquadAction.setPilotUpgrade(pilotIndex, upgrade, upgradeIndex));
          var squad = createSquad();
          store.dispatch(AgentSquadAction.setSquad(squad));
          renderSquadBuilderUI();
        }
        var shipChanged = function(ship, index)
        {
          store.dispatch(AgentSquadAction.setShip(ship, index));
          var squad = createSquad();
          store.dispatch(AgentSquadAction.setSquad(squad));
          renderSquadBuilderUI();
        };

        ReactDOM.render(createFactionSelect(), document.getElementById("factionSelect"));

        function createFactionSelect()
        {
          var factionValues = [Faction.IMPERIAL, Faction.REBEL, Faction.SCUM];
          var factionLabelFunction = function(value)
          {
            var answer = Faction.properties[value].name;
            var friend = Faction.friend(value);
            if (friend)
            {
              answer += " + " + Faction.properties[friend].name;
            }
            return answer;
          };

          return React.createElement(Select,
          {
            values: factionValues,
            labelFunction: factionLabelFunction,
            initialSelectedValue: faction.key,
            onChange: handleFactionChange,
          });
        }

        function createSquad()
        {
          var factionKey = faction.key;
          var name = "name";
          var year = 2017;
          var description = "description";
          var pilots = store.getState().pilots;
          var tokens = [];

          if (pilots.size > 0)
          {
            var agent = {};

            pilots.forEach(function(pilot, i)
            {
              if (pilot)
              {
                // Ignore child pilots.
                if (!pilot.parent)
                {
                  var myPilot = (pilot.fore ? pilot.fore : pilot);
                  var upgrades = store.getState().pilotIndexToUpgrades.get(i);
                  var upgradeKeys = [];
                  upgrades.forEach(function(upgrade)
                  {
                    if (upgrade)
                    {
                      upgradeKeys.push(upgrade.key);
                    }
                  });

                  var upgradeKeysAft;
                  myPilot = (pilot.aft ? pilot.aft : undefined);

                  if (myPilot)
                  {
                    upgrades = store.getState().pilotIndexToUpgrades.get(i);
                    upgradeKeysAft = [];
                    upgrades.forEach(function(upgrade)
                    {
                      if (upgrade)
                      {
                        upgradeKeysAft.push(upgrade.key);
                      }
                    });
                  }

                  tokens.push(new CardInstance(delegateStore, pilot.key, agent, upgradeKeys, upgradeKeysAft));
                }
              }
            }, this);
          }

          return new Squad(factionKey, name, year, description, tokens);
        };

        function handleFactionChange(event)
        {
          var factionKey = event.currentTarget.value;
          faction = Faction.properties[factionKey];
          store = Redux.createStore(AgentSquadReducer.root);
          renderSquadBuilderUI();
        }

        function renderSquadBuilderUI()
        {
          var element = React.createElement(SquadBuilderUI,
          {
            delegateStore: delegateStore,
            displayItem: store.getState().displayItem,
            faction: faction,
            pilotIndexToUpgrades: store.getState().pilotIndexToUpgrades,
            pilots: store.getState().pilots,
            resourceBase: resourceBase,
            ships: store.getState().ships,
            squad: store.getState().squad,
            squadBuilderAction: AgentSquadAction,
            squadClass: Squad,
            tokenFactory: CardInstance,

            displayItemChanged: displayItemChanged,
            pilotChanged: pilotChanged,
            pilotUpgradeChanged: pilotUpgradeChanged,
            shipChanged: shipChanged,
          });
          ReactDOM.render(element, document.getElementById("squadBuilderPanel"));
        };

        renderSquadBuilderUI();
      });
  </script>
</body>

</html>
